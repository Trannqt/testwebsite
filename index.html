<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>jQuery UI Widget - Default functionality</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

  <script>
	function onlyUnique(value, index, self) {
	  return self.indexOf(value) === index;
	}
	
	function processCheckNoLock(txtQuery, callback){
	debugger
		txtQuery = txtQuery.toString().toLowerCase().trim().replace(/\s+/g, ' ');
		var updated = checkNoLock(txtQuery);
		console.log(updated);
		updated = updated.replaceAll('<b style="color:red;">MISS_NOLOCK</b> (nolock)','(nolock)');
		
		if(callback) callback(updated);
	}
	
	function checkNoLock(query) {
		debugger
		const tableRegex = /(from|join)\s+(\w+\.*){1,2}\w+(\s|$)/g;
		var match = query.match(tableRegex);
		var uniqueMatch = match.filter(onlyUnique);
		let updatedQuery = query;
		if (uniqueMatch) {
			uniqueMatch.forEach(table => {
				updatedQuery = updatedQuery.replace(table, `${table} <b style="color:red;">MISS_NOLOCK</b> `);
			});
		}
		return updatedQuery;
	}
	
	async function handleFiles() {
		const files = this.files;
		$("#resultQuery").html("");
		for (let i = 0; i < files.length; i++) {
			const file = files[i];
			const reader = new FileReader();
			reader.onload = function() {
				let text = "";
				text += `<b style="color: blue;">File Name ${i+1}: ${file.name}</b>`;
				text += `${reader.result}<br/><br/>`;
				processCheckNoLock(text, (updated)=>{
					$("#resultQuery").append(updated);
				});
			};
			await reader.readAsText(file);
		}
	}

	$( document ).ready(function() {
		$( "#btnSubmit" ).click(function() {
			$("#resultQuery").html("");
		  	var txtQuery = $("#txtQuery").val();
			processCheckNoLock(txtQuery, (updated)=>{
				$("#resultQuery").html(updated);
			});
		});
		
		const input = document.getElementById("fileInput");
		input.addEventListener("change", handleFiles, false);
	});
  </script>
  <style>
	.my_nav{
		height: 50px;
		background: green;
		color: white;
		text-align: center;
		line-height: 50px;
		font-weight: bold;
		font-size: 20pt;
	}
	#txtQuery{
		width: 100%;
		height: 700px;
		padding: 15px;
	}
	#btnSubmit{
		float: right;
	}
	.RightTab{
		border: 1px solid green;
		height: 700px;
	}
	#resultQuery{
		height: 685px;
		padding: 15px;
		overflow: scroll;
	}
  </style>
</head>
<body>
<div>
	<div class="my_nav" class="myNav bg-header">
		<a>TOOL CHECK WITHOUT NOLOCK (BETA)</a>
	</div>
	
	<div class="content">
		<div class="container-fluid">
			<div class="row">
				<div class="col-6 leftTab">
					<textarea id="txtQuery"></textarea>
					<button id="btnSubmit" class="btn btn-success">Kiá»ƒm tra</button>
					<div class="files">
						<input type="file" id="fileInput" multiple />
					</div>
				</div>
				<div class="col-6 RightTab">
					<div class="row" id="resultQuery"></div>
				</div>
			</div>
		</div>
	</div>
</div>
</body>
</html>